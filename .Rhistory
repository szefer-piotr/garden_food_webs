#     subdat <- filtered_slope[filtered_slope$treatment == nm, ]
#     subdat_pl <- subdat[subdat$species == spc, ]
#     if(dim(subdat_pl)[1] == 0){
#       next
#     }
#     # Model for log-log linear relationship plant bio and invertebrate abundance
#     mod <- lm(rich~log(biomass),
#               data=subdat_pl)
#     results <- data.frame(t(summary(mod)$coefficients[2, ]),
#                           species = spc,
#                           treatment = nm,
#                           size = dim(subdat_pl)[1])
#     trt_dat <- rbind(trt_dat, results)
#   }
#   slope_estims <- rbind(slope_estims, trt_dat)
# }
# p<- ggplot(slope_estims, aes(x=treatment,
#                              y=Estimate,
#                              group=species,
#                              color=species,
#                              label = size)) +
#   geom_line() +
#   geom_point()+
#   geom_text(hjust = 3, nudge_x = 0.1,color = "black")+
#   geom_errorbar(aes(ymin=Estimate-Std..Error,
#                     ymax=Estimate+Std..Error), width=.2,
#                 position=position_dodge(0.05))
# p
# Species identity
filtered_slope$block <- substr(filtered_slope$plot,3,4)
filtered_data$block <- substr(filtered_data$plot,3,4)
library(lme4)
library(lmerTest)
# Invertebrate abundance vs species identity
# glmer1 <- glmer.nb(val~log(biomass)+species+(1|block), data=filtered_slope)
# glmer2 <- lmer(log(val)~log(biomass)+species+(1|block), data=filtered_slope)
# glmer3a <- lm(log(val)~log(biomass)+species, data=filtered_slope)
# lm3 <- lm(log(val)~log(biomass),
#            data=filtered_slope)
# lm3a <- lm(log(val)~log(biomass)+species,
#            data=filtered_slope)
# For all possible species
# Biomass ----
# Most complex model?
# This is too complicated for my limited data set
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data, REML=F)
lm1  <- lm(log(bio)~log(biomass),
data=filtered_data)
anova(lm1, lmer1, test = "Chisq")
anova(lmer1)
anova(lm1)
anova(lm1,lmer1)
install.packages("RLRsim")
filtered_data$blockConst <- factor(rep(1,
each = length(filtered_data$bio)))
filtered_data
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data)
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data)
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data, REML = F)
filtered_data$blockConst <- factor(rep(1,length(filtered_data$bio)))
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data, REML = F)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data, REML=F)
anova(lm1)
anova(lmer1)
library(RLRsim)
exactLRT(lmer1)
lm1  <- lmer(log(bio)~log(biomass,
data=filtered_data, REML = F)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data, REML=F)
anova(lm1)
anova(lmer1)
exactLRT(lmer1)
anova(lm1,lmer1)
# Random factor is not necessarry
# Lets see wether biomass predicts herbivore biomass better
lm_bio <- lm(log(bio)~log(biomass),
data=filtered_data)
lm_spc <- lm(log(bio)~species,
data=filtered_data)
lm_bio_spc <- update(lm_bio, .~.+species)
anova(lm_bio, lm_bio_spc, test = "Chisq")
lm_spc_bio <- update(lm_spc, .~.+log(biomass))
anova(lm_spc, lm_spc_bio, test = "Chisq")
# By the way, this same approach is proposed by N. W. Galwey in 'Introduction to Mixed Modelling: Beyond Regression and Analysis of Variance' on pages 213-214.
# Species identity is an important part!
# Biomass itsef is not explaining all the variability
# Do species differ in their slopes?
# Is there an interaction?
lm_int_bio_sp <-update(lm_bio_spc, .~. + log(biomass)*species)
anova(lm_bio_spc, lm_int_bio_sp)
# There is no signigficant interaction there.
# What if the slope is random? Unconstrained slopes
random_slope <- lmer(log(bio)~log(biomass)+species+(0+log(biomass)|species), data = filtered_data)
summary(random_slope)
# Form the graph it deasn't look like it.
# Variance doesn't seem to be different than zero
lm_int_bio_sp_trt <-update(lm_int_bio_sp, .~. + treatment + treatment*species*log(biomass))
anova(lm_int_bio_sp, lm_int_bio_sp_trt)
# Lets see whether treatement can affect these accumulation curves
ggplot(filtered_data, aes(x = log(biomass), y=log(bio), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)+
facet_wrap(~treatment)
lm_int <- lm(log(val)~log(biomass)+species*treatment,
data=filtered_slope)
anova(lm_no_int, lm_int, test="Chisq")
lm_no_int <- lm(log(bio)~log(biomass)+species+treatment,
data=filtered_slope)
lm_int <- lm(log(val)~log(biomass)+species*treatment,
data=filtered_slope)
anova(lm_no_int, lm_int, test="Chisq")
# Interaction term is not significant!
# filtered_slope$trtspec <- paste(filtered_slope$treatment, filtered_slope$species)
# lm3c <- lm(log(val)~log(biomass)+trtspec,
#               data=filtered_slope)
#
# summary(glmer3b)
#
# inter.test <- emmeans(glmer3c, "trtspec")
# pairwise <- cld(inter.test, Letter="abcdefghijklm")
# Abundance vs species identity ----
glmer1 <- glm.nb(abu~log(biomass)+species, data=filtered_data)
# nb model with random effect does not converge
glmer2 <- lmer(log(abu)~log(biomass)+species+(1|block), data=filtered_data)
glmer3a <- lm(log(abu)~log(biomass)+species, data=filtered_data)
AIC(glmer1, glmer2)
AIC(glmer2, glmer3a)
anova(glmer2, glmer3a)
# Negative binomial doesnt look good
# Model withouth random effect of block performs better.
summary(glmer3a)
glmer3b <- lm(log(abu)~log(biomass)*species, data=filtered_data)
anova(glmer3b, glmer3a)
# There is a marginal signifdicant interaction term in case of abundnace
ggplot(filtered_data, aes(x = log(biomass), y=log(abu), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)+
facet_wrap(~treatment)
# Richness ----
# should be Poisson?
lmer_rich <- lmer(rich~log(biomass)+species+(1|block), data=filtered_data)
lmer_rich_norand <- lm(rich~log(biomass)+species, data=filtered_data)
AIC(lmer_rich, lmer_rich_norand) # Here random is better
anova(lmer_rich, lmer_rich_norand) # And here is not :/
lm_rich_norand_int <- lm(rich~log(biomass)*species, data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_int) # no significant improvement
lm_rich_norand_trt <- lm(rich~log(biomass)+species+treatment, data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_trt) # teatment not significant
lm_rich_norand_trt_int <- lm(rich~log(biomass)*treatment+species,
data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_trt_int) # interaction not significant
lm_rich_norand_bio <- lm(rich~log(biomass), data=filtered_data)
lm_rich_norand_bio_sp <- update(lm_rich_norand_bio, .~.+species)
anova(lm_rich_norand_bio, lm_rich_norand_bio_sp) # species is significant but only for piptar
# final simplest model approximately 70% of variation
summary(lm_rich_norand_bio_sp)
ggplot(filtered_data, aes(x = log(biomass), y=rich, color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)
## glmer poisson
lmer_rich <- glmer(rich~log(biomass)+species+(1|block),family = "poisson", data=filtered_data)
lmer_rich_norand <- glm(rich~log(biomass)+species,
family="poisson",
data=filtered_data)
AIC(lmer_rich, lmer_rich_norand)
anova(lmer_rich, lmer_rich_norand) #Here random is better
# interaction with random effect is to complex for simple dataset.
lm_rich_norand_int <- update(lmer_rich_norand, .~ log(biomass)*species)
anova(lmer_rich_norand, lm_rich_norand_int, test="Chisq") # marginally significant improvement
lm_rich_norand_trt <- lm(rich~log(biomass)+species+treatment, data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_trt) # teatment not significant
lm_rich_norand_trt_int <- lm(rich~log(biomass)*treatment+species,
data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_trt_int) # interaction not significant
lm_rich_norand_bio <- lm(rich~log(biomass), data=filtered_data)
lm_rich_norand_bio_sp <- update(lm_rich_norand_bio, .~.+species)
anova(lm_rich_norand_bio, lm_rich_norand_bio_sp) # species is significant but only for piptar
# final simplest model approximately 70% of variation
summary(lm_rich_norand_bio_sp)
ggplot(filtered_data, aes(x = log(biomass), y=rich, color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)
# Diversity ----
lmer_div <- lmer(rich~log(biomass)+species+(1|block), data=filtered_data)
lmer_rich_norand <- lm(rich~log(biomass)+species, data=filtered_data)
AIC(lmer_rich, lmer_rich_norand) # Here random is better
anova(lmer_rich, lmer_rich_norand) # And here is not :/
lm_rich_norand_int <- lm(rich~log(biomass)*species, data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_int) # no significant improvement
lm_rich_norand_trt <- lm(rich~log(biomass)+species+treatment, data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_trt) # teatment not significant
lm_rich_norand_trt_int <- lm(rich~log(biomass)*treatment+species,
data=filtered_data)
anova(lmer_rich_norand, lm_rich_norand_trt_int) # interaction not significant
lm_rich_norand_bio <- lm(rich~log(biomass), data=filtered_data)
lm_rich_norand_bio_sp <- update(lm_rich_norand_bio, .~.+species)
anova(lm_rich_norand_bio, lm_rich_norand_bio_sp) # species is significant but only for piptar
# final simplest model approximately 70% of variation
summary(lm_rich_norand_bio_sp)
ggplot(filtered_data, aes(x = log(biomass), y=rich, color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)
# Notes ----
# glmer3b <- lm(log(val)~log(biomass)+species+treatment+species*treatment,
#               data=filtered_slope)
# lm3d <- lm(rich~log(biomass)+trtspec,
#               data=filtered_slope)
#
# inter.test <- emmeans(glmer3c, "trtspec")
# pairwise <- cld(inter.test, Letter="abcdefghijklm")
#
# plot(pairwise)
# ltrs <- data.frame(pt = pairwise$treat,
#                    pg = pairwise$.group)
plot(glmer1)
AIC(glmer1, glmer2, glmer3a, glmer3b,glmer3c)
)
lm1  <- lmer(log(bio)~log(biomass),
data=filtered_data)
lm1  <- lm(log(bio)~log(biomass),
data=filtered_data)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data, REML=F)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data)
exactLRT(lmer1, lm1)
lm1  <- lm(log(bio)~log(biomass),
data=filtered_data)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data)
anova(lm1)
anova(lmer1)
exactLRT(lmer1, lm1)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data,method="ML")
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data,REML=F)
exactLRT(lmer1, lm1)
filtered_data$blockConst <- 1
lm1  <- lm(log(bio)~log(biomass),
data=filtered_data)
lmer0  <- lm(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data,REML=F)
anova(lmer0, lmer1)
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data)
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data, REML = F)
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data,REML=F)
AIC(lmer0,lmer1)
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data, REML = F)
lmer0
lmer0  <- lmer(log(bio)~log(biomass)+(1|blockConst),
data=filtered_data, REML = F,control=lmerControl(check.nlev.gtr.1="ignore"))
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data,REML=F)
AIC(lmer0,lmer1)
anova(lmer0,lmer1)
ggplot(filtered_data, aes(x = block,y = log(bio)))+
geom_jitter()
ggplot(filtered_data, aes(x = block,y = log(bio)))+
geom_boxplot()
lmer1 <- lmer(log(bio)~log(biomass)+(1|block),
data=filtered_data,REML=F)
lmer1 <- nlme::lme(log(bio)~log(biomass),
random=~1|block,
data=filtered_data,REML=F)
lmer1 <- nlme::lme(log(bio)~log(biomass),
random=~1|block,
data=filtered_data)
summary(lmer1)
ranef(lmer1)
ranef(lmer1)
names(ranef(lmer1))
reaction_subject <- fixef(lmer1) + ranef(lmer1)$(Intercept)
reaction_subject <- fixef(lmer1) + ranef(lmer1)$"(Intercept)"
reaction_subject
plot(reaction_subject)
fixef(lmer1)
gls1 <- gls(log(bio)~log(biomass),
data = filtered_data)
?gls
library(nlme)
gls1 <- nlme::gls(log(bio)~log(biomass),
data = filtered_data)
anova(lmer1, gls1)
# Biomass ----
library(nlme)
# Lets see wether plant biomass predicts herbivore biomass better thanb plant identity
lm_bio <- lme(log(bio)~log(biomass),random=~1|block,
data=filtered_data)
lm_spc <- lme(log(bio)~species,random=~1|block,
data=filtered_data)
anova(lm_bio, lm_spc)
# Add species to bio and check for improvement
lm_bio_spc <- update(lm_bio, .~.+species)
anova(lm_bio, lm_bio_spc, test = "Chisq")
# Lets see wether plant biomass predicts herbivore biomass better thanb plant identity
lm_bio <- lme(log(bio)~log(biomass),random=~1|block,
data=filtered_data, REML=F)
# Lets see wether plant biomass predicts herbivore biomass better thanb plant identity
lm_bio <- lme(log(bio)~log(biomass),random=~1|block,
data=filtered_data, method = "ML")
lm_spc <- lme(log(bio)~species,random=~1|block,
data=filtered_data, method="ML")
# Add species to bio and check for improvement
lm_bio_spc <- update(lm_bio, .~.+species)
anova(lm_bio, lm_bio_spc, test = "Chisq")
anova(lm_bio, lm_bio_spc)
lm_spc_bio <- update(lm_spc, .~.+log(biomass))
anova(lm_spc, lm_spc_bio, test = "Chisq")
anova(lm_spc, lm_spc_bio)
anova(lm_bio_spc, lm_spc_bio)
# Lets see wether plant biomass predicts herbivore biomass better thanb plant identity
lm_bio <- lme(log(bio)~log(biomass),random=~1|block,
data=filtered_data, method = "ML")
# Add species to bio and check for improvement
lm_bio_spc <- update(lm_bio, .~.+species)
lm_bio_spc
summary(lm_bio_spc)
R2(lm_bio)
# Lets see wether plant biomass predicts herbivore biomass better thanb plant identity
lm_bio <- lme(log(bio)~0+log(biomass),random=~1|block,
data=filtered_data, method = "ML")
lm_spc <- lme(log(bio)~0+species,random=~1|block,
data=filtered_data, method="ML")
# Add species to bio and check for improvement
lm_bio_spc <- update(lm_bio, .~.+species)
summary(lm_bio_spc)
anova(lm_bio, lm_bio_spc)
# Do species differ in their slopes?
# Is there an interaction?
lm_int_bio_sp <-update(lm_bio_spc, .~. + log(biomass)*species)
anova(lm_bio_spc, lm_int_bio_sp)
summary(lm_bio)
# Add species to bio and check for improvement
lm_bio_spc <- update(lm_bio, .~.+species)
summary(lm_spc)
install.packages("sjstats")
library(sjstats)
r2(lm_bio)
r2(lm_spc)
performance::r2(lm_spc)
lm_spc <- lme(log(bio)~species,random=~1|block,
data=filtered_data, method="ML")
r2(lm_bio)
performance::r2(lm_spc)
lm_spc
anova(lm_bio, lm_spc)
R2(lm_bio)
r2(lm_bio)
# Do species differ in their slopes?
# Is there an interaction?
lm_int_bio_sp <-update(lm_bio_spc, .~. + log(biomass)*species)
anova(lm_bio_spc, lm_int_bio_sp)
# What if the slope is random? Unconstrained slopes
random_slope <- lmer(log(bio)~log(biomass)+species+(0+log(biomass)|species), data = filtered_data)
summary(random_slope)
random_slope <- lmer(log(bio)~log(biomass)+species,
random = ~ 0+log(biomass)|species, data = filtered_data)
random_slope <- nlme::lme(log(bio)~log(biomass)+species,
random = ~ 0+log(biomass)|species, data = filtered_data)
summary(random_slope)
summary(random_slope)
# Abundance vs species identity ----
glmer1 <- glm.nb(abu~log(biomass)+species, data=filtered_data)
glmer2 <- lmer(log(abu)~log(biomass)+species+(1|block), data=filtered_data)
glmer3a <- lm(log(abu)~log(biomass)+species, data=filtered_data)
AIC(glmer1, glmer2)
AIC(glmer2, glmer3a)
anova(glmer2, glmer3a)
summary(glmer3a)
anova(glmer3b, glmer3a)
ggplot(filtered_data, aes(x = log(biomass), y=log(abu), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)+
facet_wrap(~treatment)
filtered_data$bio
# In grams
filtered_data$bio <- filtered_data$bio*1000
glmer1 <- glm.nb(abu~log(biomass)+species, data=filtered_data)
glmer2 <- lmer(log(abu)~log(biomass)+species+(1|block), data=filtered_data)
glmer3a <- lm(log(abu)~log(biomass)+species, data=filtered_data)
AIC(glmer1, glmer2)
AIC(glmer2, glmer3a)
anova(glmer2, glmer3a)
summary(glmer3a)
anova(glmer2, glmer3a)
summary(glmer3a)
# Interaction
glmer3b <- lm(log(abu)~log(biomass)*species, data=filtered_data)
anova(glmer3b, glmer3a)
glmer3b
summary(glmer3b)
ggplot(filtered_data, aes(x = log(biomass), y=log(abu), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)+
facet_wrap(~treatment)
filtered_data
# In grams
filtered_data$biomass <- filtered_data$biomass*1000
# In grams (plant biomass)
filtered_data$biomass <- filtered_data$biomass*1000
glmer1 <- glm.nb(abu~log(biomass)+species, data=filtered_data)
glmer2 <- lmer(log(abu)~log(biomass)+species+(1|block), data=filtered_data)
glmer3a <- lm(log(abu)~log(biomass)+species, data=filtered_data)
AIC(glmer1, glmer2)
AIC(glmer2, glmer3a)
anova(glmer2, glmer3a)
summary(glmer3a)
# Interaction
glmer3b <- lm(log(abu)~log(biomass)*species, data=filtered_data)
summary(glmer3b)
anova(glmer3b, glmer3a)
ggplot(filtered_data, aes(x = log(biomass), y=log(abu), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)+
facet_wrap(~treatment)
# regression through the origin
glmer3c <- lm(log(abu)~0+log(biomass)*species, data=filtered_data)
summary(glmer3c)
glmer3c.1 <- lm(log(abu)~0+log(biomass)+species, data=filtered_data)
glmer3c.2 <- lm(log(abu)~0+log(biomass)*species, data=filtered_data)
anova(glmer3c.1)
anova(glmer3c.1, glmer3c.2)
# regression through the origin
glmer3c.0 <- lm(log(abu)~0+log(biomass), data=filtered_data)
anova(glmer3c.0, glmer3c.1) # marginally significant again!
summary(glmer3c)
summary(glmer3c.0)
summary(glmer3c.1)
y_new <- simulate(glmer3c.0)
y_new
y_new <- simulate(glmer3c.1)
y_new
y_new <- simulate(glmer3c.2)
y_new
filtered_data
new_dat <- filtered_data[, c("plot","species","biomass", "treatment",
"block")]
new_dat$mod0 <- simulate(glmer3c.0)
new_dat$mod0 <- simulate(glmer3c.0)
new_dat$mod1 <- simulate(glmer3c.1)
new_dat$mod2 <- simulate(glmer3c.2)
ggplot(filtered_data, aes(x = log(biomass), y=log(abu), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=FALSE)
ggplot(filtered_data, aes(x = log(biomass), y=log(abu), color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=T)
new_dat
ggplot(filtered_data, aes(x = log(biomass),
y=mod0,
color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=T)
new_dat
ggplot(new_dat, aes(x = log(biomass),
y=mod0,
color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=T)
new_dat
new_dat$mod0 <- simulate(glmer3c.0)[,1]
new_dat$mod1 <- simulate(glmer3c.1)[,1]
new_dat$mod2 <- simulate(glmer3c.2)[,1]
new_dat
ggplot(new_dat, aes(x = log(biomass),
y=mod0,
color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=T)
ggplot(new_dat, aes(x = log(biomass),
y=mod1,
color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=T)
ggplot(new_dat, aes(x = log(biomass),
y=mod2,
color = species))+
geom_jitter()+
geom_smooth(method = "lm", se=T)
anova(glmer3c.1, glmer3c.2) # marginally significant again!
# Is treatment significant
glmer3c.0 <- lm(log(abu)~0+log(biomass), data=filtered_data)
glmer3c.1 <- lm(log(abu)~0+log(biomass)+treatment, data=filtered_data)
# Is treatment significant
glmer3c.0 <- lm(log(abu)~0+log(biomass), data=filtered_data)
glmer3c.1 <- lm(log(abu)~0+log(biomass)+treatment, data=filtered_data)
glmer3c.2 <- lm(log(abu)~0+log(biomass)*treatment, data=filtered_data)
glmer3c.3 <- lm(log(abu)~0+log(biomass)*species*treatment, data=filtered_data)
anova(glmer3c.0)
anova(glmer3c.0,glmer3c.1,glmer3c.2,glmer3c.3)
# For each species and for each treatment I can get an estimate of the slope parameter
filtered_slope <- filtered_data[filtered_data$species %in% c("melamu", "piptar"),]
# Is treatment significant
glmer3c.0 <- lm(log(abu)~0+log(biomass), data=filtered_slope)
glmer3c.1 <- lm(log(abu)~0+log(biomass)+treatment, data=filtered_slope)
glmer3c.2 <- lm(log(abu)~0+log(biomass)*treatment, data=filtered_slope)
glmer3c.3 <- lm(log(abu)~0+log(biomass)*species*treatment, data=filtered_slope)
anova(glmer3c.0,glmer3c.1,glmer3c.2,glmer3c.3)
