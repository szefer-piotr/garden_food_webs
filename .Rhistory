specdat_noip <- specdat[-grep("aran|mant", specdat)]
biosub <- inssub[inssub$morphotype %in% specdat_noip, ]
biosub$block <- substr(biosub$plot, 3,4)
# Fill in later
biosub$ipbio <- 0
biosub$ipabu <- 0
# remove unused columns
bsc <- biosub[,c("morphotype", "amount", "bio", "totbio",
"ipbio", "ipabu",
"tree", "family", "morph", "plbio", "db",
"treat", "block")]
# get some indication of food quality for plants and instead of using species
# use that indincation
source("code/plant_species_quality.R")
plant_quality
bsc$quality <- plant_quality[bsc$tree, 1]
bsc$palat <- plant_quality[bsc$tree, 2]
library(ggplot2)
# Evaluate the response
qqnorm(log(bsc$totbio), col = alpha("black", 0.1))
qqline(log(bsc$totbio))
hist(bsc$totbio, breaks = 100)
summary(log(bsc$totbio))
# it is not hugely different from the normal
qqnorm(log(bsc[bsc$treat == "predator", ]$totbio), col = alpha("black", 0.1))
qqline(log(bsc[bsc$treat == "predator", ]$totbio))
qqnorm(log(bsc[bsc$treat == "control", ]$totbio), col = alpha("black", 0.1))
qqline(log(bsc[bsc$treat == "control", ]$totbio))
hist(log(bsc[bsc$treat == "predator", ]$totbio), breaks = 20, col="red")
hist(log(bsc[bsc$treat == "control", ]$totbio), breaks = 20)
ggplot(bsc, aes(x = log(totbio), fill = treat)) + geom_density(alpha = 0.2)
library(lme4)
library(lmerTest)
# Hypotheses for models:
# TTI dietary specialist herbivore should be less affected by enemies, doesnt matter whether on poor or high quality resources. Generalists on the other hand should be strongly negatively affecte by predators on low quality food. pd*quality.
# Howoever, if generalist can move (mobility), then these effects should not be as strong, and maybe there will be no differences in mobile groups.
# Schmitz evaluated the effect of size (page 128 in "Resolving... "): small grashoppers have a lower capacity tto digest and assimilate much of the vegetation in the fields oowing to its generally poor quality. Smaller grashoppers must sttpend considerable effort seeking high quality plants resources that tend to be rare. This can highten starvation mortality of individuals in smaller size classes relative to larger individuals owing to greater  predation mortality due to more risk prone foraging behaviour by small individuals... however, there was little or no difference in the effect of grasshopper size class on the final abundance of grasses and herbs in the plant community. Grasshoppers in smaller size classes exhibited higher growth rates. These can be only sustained by higher foraging effert. Lower density is compensated by the effect of greater per capita foraging effort of the surviving individuals.
# Percentage water content
nms <- main$SP_CODE
wat <- main$WATER/main$WET..g.
speccode <- paste(main$CODE, tolower(main$SP_CODE), sep = "")
plot(wat~nms)
# Does treatment have an overal effect on herbivore biomass
LMER1 <- glmer(amount ~ treat+(1|block), data=bsc, family = "poisson")
LMER1nb <- glmer.nb(amount ~ treat+(0+treat|tree), data=bsc)
summary(LMER1nb)
library(blmeco)
dispersion_glmer(LMER1) # should not exceed 1.4
library(emmeans)
plot(emmeans(LMER1nb,"treat",adjust = "tukey"))
emmeans(LMER1nb, list(pairwise~treat))
# library(lme4)
# effect.out.lme <- effect(term = "treat",
#                          mod = LMER1nb)
# boxplot(log(bsc[complete.cases(bsc),]$totbio)~bsc[complete.cases(bsc),]$treat)
LMER1 <- lmer(log(totbio) ~ treat+offset(plbio)+(1|block), data=bsc)
LMER1b <- lmer(log(totbio) ~ treat*quality+(1+treat|tree) + offset(log(bio)), data=bsc)
summary(LMER1b)
LMER1b <- glmer(amount ~ treat*quality+(1+treat|db), data=bsc, family = "poisson")
summary(LMER1b)
# Why to uses offset ? - log biomass of species is actually larger on more abundant plants, but this account for only 11% of variation
plot(log(totbio)~log(plbio), data=bsc, col = alpha("black", 0.1), pch=19)
abline(lm(log(totbio)~log(plbio), data=bsc)
)
summary(lm(log(totbio)~log(plbio), data=bsc))
# I dont think I need to use it at all.
unique(bsc$db)
# visualize
qvals <- unique(bsc$quality)
ut <- unique(bsc$tree)
sort(plant_quality[as.character(ut), ])
form <- plbio~plant_quality[names(plbio),1]
plot(form)
poor <- "breyce"
high <- "pipeum"
average <- "piptar"
subbsc <- bsc[bsc$tree == poor, ]
subbsc <- bsc[bsc$tree == high, ]
subbsc <- bsc[bsc$tree == average, ]
#
ggplot(subbsc, aes(y = log(totbio), x = treat,
col = db,
group = db)) +
stat_summary(fun.data=mean_cl_boot,
geom="pointrange", lwd=0.8) +
stat_summary(fun=mean, geom="point",cex = 2) +
stat_summary(fun=mean, geom="line",lwd=1, lty=2)
# stat_summary(fun.y=mean, geom="text",
#              col = rgb(10,10,10,180,maxColorValue = 255),
#              hjust = 1.2,
#              vjust = -1.5)
plot(log(bio)~db, data = bsc, xlim = c(0.8, 1))
plot(bsc$quality~bsc$db)
# Comparison between plant species
# Rename variables
# names(bsc) <- c("species","habu","hsize","hbio",
#                 "ipbio","ipabu","treesp", "hfam",
#                 "spec", "plbio", "db", "treat",
#                 "block","quality","palat")
ggplot(subbsc, aes(y = log(amount+1), x = treat,
col = db,
group = db)) +
stat_summary(fun.data=mean_cl_boot,
geom="pointrange", lwd=0.8) +
stat_summary(fun=mean, geom="point",cex = 2) +
stat_summary(fun=mean, geom="line",lwd=1, lty=2)
# Full interaction model
# Check how much data I have for each interaction
library(dplyr)
library(tidyr)
# Example
# loc<-c("city1","city2","city1","city2","city1","city1","city2","city2","city1","city2")
# q1<-c("YES","YES","NO","MAYBE","NO","NO","YES","NO","MAYBE","MAYBE")
# q2<-c("YES","NO","MAYBE","YES","NO","MAYBE","MAYBE","YES","YES","NO")
# q3<-c("NO","NO","NO","NO","YES","YES","MAYBE","MAYBE","NO","MAYBE")
# df<-data.frame(loc,q1,q2,q3)
# dfN <- gather(df, quest, answ, q1:q3) %>%
#   complete(loc, quest, answ) %>%
#   unique()
# bsc$db
#db, quality
mean(bsc$db)
bsc$specialization <- "generalist"
bsc[bsc$db <= mean(bsc$db), ]$specialization <- "specialists"
bsc$pqual <- "poor"
bsc[bsc$quality >= mean(bsc$quality, na.rm = T), ]$pqual <- "high"
bscN <- group_by(bsc, specialization, pqual, treat) %>%
tally()
bscN %>% tbl_df %>% print(n=40)
rm(list=ls())
source("code/data_processing_code.R")
source("code/pdi.R")
ins_bio$block <- substr(ins_bio$plot, 3,4)
treats$treat <- tolower(treats$treat)
treats$block <- substr(treats$codes, 3,4)
# predator vs control
cpsites <- as.character(treats[treats$treat %in% c("control",
"predator"),]$codes)
cpfull <- ins_bio[ins_bio$plot %in% cpsites, ]
# remove ip
cpfull_noip <- cpfull[-grep("aran|mant", cpfull$morphotype), ]
cpfull_noip$morphotype <- as.character(cpfull_noip$morphotype)
# For each block get species which are comparable
bl <- "g1"
slgfulldat <- data.frame()
for(bl in unique(cpfull_noip$block)){
subbl <- cpfull_noip[cpfull_noip$block == bl,]
psite <- treats[treats$block == bl & treats$treat == "predator", ]$codes
csite <- treats[treats$block == bl & treats$treat == "control", ]$codes
psite <- as.character(psite)
csite <- as.character(csite)
pdat <- subbl[subbl$plot == psite, ]
cdat <- subbl[subbl$plot == csite, ]
pmat <- contingencyTable2(pdat, "tree", "morphotype", "totbio")
cmat <- contingencyTable2(cdat, "tree", "morphotype", "totbio")
#stayed
stayed <- colnames(cmat)[colnames(cmat) %in% colnames(pmat)]
#lost
`%notin%` <- Negate(`%in%`)
lost <- colnames(cmat)[colnames(cmat) %notin% colnames(pmat)]
#gained
gained <- colnames(pmat)[colnames(pmat) %notin% colnames(cmat)]
allnames <- length(unique(c(colnames(pmat), colnames(cmat))))
length(c(stayed, lost, gained)) == allnames # do we have all of them?
# pdi
staydf <- data.frame(pdi = diet_breadth[stayed],
type = "stayed")
lostdf <- data.frame(pdi = diet_breadth[lost],
type = "lost")
gainedf <- data.frame(pdi = diet_breadth[gained],
type = "gained")
slgdat <- rbind(staydf, lostdf, gainedf)
slgdat$block <- bl
slgfulldat <- rbind(slgfulldat, slgdat)
}
slgfulldat
dim(slgfulldat)
slgfullnozero <- slgfulldat[slgfulldat$pdi != 0, ]
dim(slgfullnozero)
compdf <- data.frame()
for(bl in unique(treats$block)){
subbl <- cpfull_noip[cpfull_noip$block == bl,]
psite <- treats[treats$block == bl & treats$treat == "predator", ]$codes
csite <- treats[treats$block == bl & treats$treat == "control", ]$codes
pn <- gardnets[[psite]]
cn <- gardnets[[csite]]
mtnms <- colnames(cn)[colnames(cn) %in% colnames(pn)]
ratios <- colSums(pn[,mtnms])/colSums(cn[,mtnms])
dbs <- diet_breadth[mtnms]
plot(log(ratios)~dbs)
bldf <- data.frame(spec = mtnms, ratio = ratios, pdi = dbs, block = bl)
compdf <- rbind(compdf, bldf)
}
compdf_niop <- compdf[-grep("aran|mant", compdf$spec), ]
library(lme4)
library(lmerTest)
# weights
ins_bio$morphotype <- as.character(ins_bio$morphotype)
morphbios  <- tapply(ins_bio$totbio, ins_bio$morphotype, sum, na.rm=T)
compdf_niop$bio <- morphbios[compdf_niop$spec]
library(RColorBrewer)
library(ggplot2)
dotcols <- brewer.pal(6, "BrBG")
dotcols <- alpha(dotcols, 0.5)
compdf_niop$lratio <- log(compdf_niop$ratio)
compdf_niop$alratio <- abs(compdf_niop$lratio)
plot(lratio~pdi, data = compdf_niop,
pch = 19, col = dotcols, cex = log(compdf_niop$bio*10))
lmer1 <- lmer(lratio~pdi+(1|block),
data = compdf_niop,
weights = bio)
summary(lmer1)
summary(lmer1)
sl <- summary(lmer1)
sl
sl[1,1]
sl$coefficients[1,1]
abline(sl$coefficients[1,1],
sl$coefficients[1,2], lwd = 3,  col = alpha("black", 0.5))
pdi
compdf_niop
lmer1 <- lmer(lratio~pdi+(1|block),
data = compdf_niop,
weights = bio)
sl <- summary(lmer1)
sl
plot(lratio~pdi, data = compdf_niop,
pch = 19, col = dotcols, cex = log(compdf_niop$bio*10))
lmer1 <- lmer(lratio~pdi+(1|block),
data = compdf_niop,
weights = bio)
lmer1
abline(sl$coefficients[1,1],
sl$coefficients[2,1], lwd = 3,  col = alpha("black", 0.5))
abline(h=0,col = alpha("black", 0.5), lty = 2)
rm(list=ls())
source("code/data_processing_code.R")
source("code/pdi.R")
ins_bio$block <- substr(ins_bio$plot, 3,4)
treats$treat <- tolower(treats$treat)
treats$block <- substr(treats$codes, 3,4)
# predator vs control
cpsites <- as.character(treats[treats$treat %in% c("control",
"predator"),]$codes)
cpfull <- ins_bio[ins_bio$plot %in% cpsites, ]
# remove ip
cpfull_noip <- cpfull[-grep("aran|mant", cpfull$morphotype), ]
cpfull_noip$morphotype <- as.character(cpfull_noip$morphotype)
# For each block get species which are comparable
bl <- "g1"
slgfulldat <- data.frame()
for(bl in unique(cpfull_noip$block)){
subbl <- cpfull_noip[cpfull_noip$block == bl,]
psite <- treats[treats$block == bl & treats$treat == "predator", ]$codes
csite <- treats[treats$block == bl & treats$treat == "control", ]$codes
psite <- as.character(psite)
csite <- as.character(csite)
pdat <- subbl[subbl$plot == psite, ]
cdat <- subbl[subbl$plot == csite, ]
pmat <- contingencyTable2(pdat, "tree", "morphotype", "totbio")
cmat <- contingencyTable2(cdat, "tree", "morphotype", "totbio")
#stayed
stayed <- colnames(cmat)[colnames(cmat) %in% colnames(pmat)]
#lost
`%notin%` <- Negate(`%in%`)
lost <- colnames(cmat)[colnames(cmat) %notin% colnames(pmat)]
#gained
gained <- colnames(pmat)[colnames(pmat) %notin% colnames(cmat)]
allnames <- length(unique(c(colnames(pmat), colnames(cmat))))
length(c(stayed, lost, gained)) == allnames # do we have all of them?
# pdi
staydf <- data.frame(pdi = diet_breadth[stayed],
type = "stayed")
lostdf <- data.frame(pdi = diet_breadth[lost],
type = "lost")
gainedf <- data.frame(pdi = diet_breadth[gained],
type = "gained")
slgdat <- rbind(staydf, lostdf, gainedf)
slgdat$block <- bl
slgfulldat <- rbind(slgfulldat, slgdat)
}
slgfulldat
dim(slgfulldat)
slgfullnozero <- slgfulldat[slgfulldat$pdi != 0, ]
dim(slgfullnozero)
compdf <- data.frame()
for(bl in unique(treats$block)){
subbl <- cpfull_noip[cpfull_noip$block == bl,]
psite <- treats[treats$block == bl & treats$treat == "predator", ]$codes
csite <- treats[treats$block == bl & treats$treat == "control", ]$codes
pn <- gardnets[[psite]]
cn <- gardnets[[csite]]
mtnms <- colnames(cn)[colnames(cn) %in% colnames(pn)]
ratios <- colSums(pn[,mtnms])/colSums(cn[,mtnms])
dbs <- diet_breadth[mtnms]
plot(log(ratios)~dbs)
bldf <- data.frame(spec = mtnms, ratio = ratios, pdi = dbs, block = bl)
compdf <- rbind(compdf, bldf)
}
compdf_niop <- compdf[-grep("aran|mant", compdf$spec), ]
library(lme4)
library(lmerTest)
# weights
ins_bio$morphotype <- as.character(ins_bio$morphotype)
morphbios  <- tapply(ins_bio$totbio, ins_bio$morphotype, sum, na.rm=T)
compdf_niop$bio <- morphbios[compdf_niop$spec]
library(RColorBrewer)
library(ggplot2)
dotcols <- brewer.pal(6, "BrBG")
dotcols <- alpha(dotcols, 0.5)
compdf_niop$lratio <- log(compdf_niop$ratio)
compdf_niop$alratio <- abs(compdf_niop$lratio)
# PDI and lratio ----
plot(lratio~pdi, data = compdf_niop,
pch = 19, col = dotcols, cex = log(compdf_niop$bio*10))
lmer1 <- lmer(lratio~pdi+(1|block),
data = compdf_niop,
weights = bio)
sl <- summary(lmer1)
abline(sl$coefficients[1,1],
sl$coefficients[2,1], lwd = 3,  col = alpha("black", 0.5))
abline(h=0,col = alpha("black", 0.5), lty = 2)
# plot
library(ggplot2)
gray <- rgb(0,0,0,50,maxColorValue = 255)
ggplot(slgfullnozero, aes(x = type, y = log(pdi),
color = ))+
geom_jitter(width = 0.1, color = gray, pch=19) +
stat_summary(fun.y = mean, geom = "point", col= "red")+
stat_summary(fun.data = "mean_cl_boot",
geom = "errorbar",
width=0.05, col="red", lwd=1.1)
ggplot(slgfullnozero, aes(x = type, y = pdi,
color = ))+
geom_jitter(width = 0.1, color = gray, pch=19) +
stat_summary(fun.y = mean, geom = "point", col= "red")+
stat_summary(fun.data = "mean_cl_boot",
geom = "errorbar",
width=0.05, col="red", lwd=1.1)
ggplot(slgfullnozero, aes(x = type, y = pdi,
color = ))+
geom_jitter(width = 0.1, color = gray, pch=19) +
stat_summary(fun = mean, geom = "point", col= "red")+
stat_summary(fun.data = "mean_cl_boot",
geom = "errorbar",
width=0.05, col="red", lwd=1.1)
# There is no difference in PDI for species lost, gained or stayed in the plot
library(lme4)
library(lmerTest)
library(emmeans)
lmer1 <-(lmer(pdi~type+(1|block), slgfullnozero))
inter.test1 <- emmeans(lmer1, "type")
plot(inter.test1)
slgfullnozero
ins_bio
rownames(ins_bio) <- ins_bio$morphotype
names(ins_bio)
ins_bio$morphplot <- paste(ins_bio$morphotype,
ins_bio$plot, sep="")
slgfullnozero
# Resource switching
rm(list=ls())
source("code/data_processing_code.R")
source("code/pdi.R")
ins_bio$block <- substr(ins_bio$plot, 3,4)
treats$treat <- tolower(treats$treat)
treats$block <- substr(treats$codes, 3,4)
# predator vs control
cpsites <- as.character(treats[treats$treat %in% c("control",
"predator"),]$codes)
cpfull <- ins_bio[ins_bio$plot %in% cpsites, ]
# remove ip
cpfull_noip <- cpfull[-grep("aran|mant", cpfull$morphotype), ]
cpfull_noip$morphotype <- as.character(cpfull_noip$morphotype)
# For each block get species which are comparable
bl <- "g1"
slgfulldat <- data.frame()
for(bl in unique(cpfull_noip$block)){
subbl <- cpfull_noip[cpfull_noip$block == bl,]
psite <- treats[treats$block == bl & treats$treat == "predator", ]$codes
csite <- treats[treats$block == bl & treats$treat == "control", ]$codes
psite <- as.character(psite)
csite <- as.character(csite)
pdat <- subbl[subbl$plot == psite, ]
cdat <- subbl[subbl$plot == csite, ]
pmat <- contingencyTable2(pdat, "tree", "morphotype", "totbio")
cmat <- contingencyTable2(cdat, "tree", "morphotype", "totbio")
#stayed
stayed <- colnames(cmat)[colnames(cmat) %in% colnames(pmat)]
#lost
`%notin%` <- Negate(`%in%`)
lost <- colnames(cmat)[colnames(cmat) %notin% colnames(pmat)]
#gained
gained <- colnames(pmat)[colnames(pmat) %notin% colnames(cmat)]
allnames <- length(unique(c(colnames(pmat), colnames(cmat))))
length(c(stayed, lost, gained)) == allnames # do we have all of them?
# pdi
staydf <- data.frame(pdi = diet_breadth[stayed],
type = "stayed")
lostdf <- data.frame(pdi = diet_breadth[lost],
type = "lost")
gainedf <- data.frame(pdi = diet_breadth[gained],
type = "gained")
slgdat <- rbind(staydf, lostdf, gainedf)
slgdat$block <- bl
slgfulldat <- rbind(slgfulldat, slgdat)
}
slgfulldat
dim(slgfulldat)
slgfullnozero <- slgfulldat[slgfulldat$pdi != 0, ]
dim(slgfullnozero)
# Weighted lratio of individual species change vs PDI ----
compdf <- data.frame()
for(bl in unique(treats$block)){
subbl <- cpfull_noip[cpfull_noip$block == bl,]
psite <- treats[treats$block == bl & treats$treat == "predator", ]$codes
csite <- treats[treats$block == bl & treats$treat == "control", ]$codes
pn <- gardnets[[psite]]
cn <- gardnets[[csite]]
mtnms <- colnames(cn)[colnames(cn) %in% colnames(pn)]
ratios <- colSums(pn[,mtnms])/colSums(cn[,mtnms])
dbs <- diet_breadth[mtnms]
plot(log(ratios)~dbs)
bldf <- data.frame(spec = mtnms, ratio = ratios, pdi = dbs, block = bl)
compdf <- rbind(compdf, bldf)
}
compdf_niop <- compdf[-grep("aran|mant", compdf$spec), ]
library(lme4)
library(lmerTest)
# weights
ins_bio$morphotype <- as.character(ins_bio$morphotype)
morphbios  <- tapply(ins_bio$totbio, ins_bio$morphotype, sum, na.rm=T)
compdf_niop$bio <- morphbios[compdf_niop$spec]
library(RColorBrewer)
library(ggplot2)
dotcols <- brewer.pal(6, "BrBG")
dotcols <- alpha(dotcols, 0.5)
compdf_niop$lratio <- log(compdf_niop$ratio)
compdf_niop$alratio <- abs(compdf_niop$lratio)
# PDI and lratio ----
plot(lratio~pdi, data = compdf_niop,
pch = 19, col = dotcols, cex = log(compdf_niop$bio*10))
lmer1 <- lmer(lratio~pdi+(1|block),
data = compdf_niop,
weights = bio)
sl <- summary(lmer1)
abline(sl$coefficients[1,1],
sl$coefficients[2,1], lwd = 3,  col = alpha("black", 0.5))
abline(h=0,col = alpha("black", 0.5), lty = 2)
# plot
library(ggplot2)
gray <- rgb(0,0,0,50,maxColorValue = 255)
ggplot(slgfullnozero, aes(x = type, y = pdi,
color = ))+
geom_jitter(width = 0.1, color = gray, pch=19) +
stat_summary(fun = mean, geom = "point", col= "red")+
stat_summary(fun.data = "mean_cl_boot",
geom = "errorbar",
width=0.05, col="red", lwd=1.1)
# There is no difference in PDI for species lost, gained or stayed in the plot
library(lme4)
library(lmerTest)
library(emmeans)
ins_bio$morphplot <- paste(ins_bio$morphotype,
ins_bio$plot, sep="")
rownames(ins_bio) <- ins_bio$morphotype
slgfullnozero$abundance <- ins_bio
lmer1 <-(lmer(pdi~type+(1|block), slgfullnozero))
diet_breadth
diet_breadth["orth024"]
abund <- ins_bio[, c("morphotype","totbio")]
abund$morphotype <- as.character(abund$morphotype)
abund$db <- diet_breadth[abund$morphotype]
abund_noip <- abund[-grep("aran|mant", abund$morphotype), ]
plot(totbio~db ,abund_noip, pch=19, col = gray,
xlab = "PDI", ylab="Biomass")
abund_noip$db
min(abund_noip$db)
min(abund_noip$db, na.rm = T)
plot(totbio~db ,abund_noip[!is.na(abund_noip$db),], pch=19, col = gray,
xlab = "PDI", ylab="Biomass")
plot(totbio~db ,
abund_noip[!is.na(abund_noip$db) & abund_noip$db != 0,],
pch=19, col = gray,
xlab = "PDI", ylab="Biomass")
anip <- abund_noip[!is.na(abund_noip$db) & abund_noip$db != 0,]
plot(totbio~db ,
anip,
pch=19, col = gray,
xlab = "PDI", ylab="Biomass")
library(MASS)
glm1 <- glm(totbio~db, anip, family = gaussian(link="log"))
summary(glm1)
summary(glm1)
ndat <- data.frame(db = seq(0,3.5,by=0.01))
res <- predict(glm1, newdata = ndat,
type = "response",
se.fit = T)
lines(res$fit~ndat$db, lwd =2, col = "red")
res
# PDI and lratio ----
plot(lratio~pdi, data = compdf_niop,
pch = 19, col = dotcols, cex = log(compdf_niop$bio*10))
lmer1 <- lmer(lratio~pdi+(1|block),
data = compdf_niop,
weights = bio)
sl <- summary(lmer1)
abline(sl$coefficients[1,1],
sl$coefficients[2,1], lwd = 3,  col = alpha("black", 0.5))
abline(h=0,col = alpha("black", 0.5), lty = 2)
sl
compdf_niop
